<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VideoRAG — Search anything, anytime</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      * {
        font-family: "Inter", sans-serif;
      }
      .glass {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .result-card:hover {
        transform: translateY(-2px);
        transition: all 0.2s;
      }
      .tab-active {
        border-bottom: 2px solid #6366f1;
        color: #6366f1;
      }
      .spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #374151;
        border-radius: 2px;
      }
    </style>
  </head>
  <body class="bg-gray-950 text-gray-100 min-h-screen">
    <!-- Header -->
    <header
      class="border-b border-gray-800 px-6 py-4 flex items-center justify-between sticky top-0 bg-gray-950 z-50"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center"
        >
          <i data-lucide="video" class="w-4 h-4 text-white"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold tracking-tight">VideoRAG</h1>
          <p class="text-xs text-gray-500">Search anything, anytime</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="status-dot" class="w-2 h-2 rounded-full bg-gray-600"></span>
        <span id="status-text" class="text-xs text-gray-500">Checking...</span>
      </div>
    </header>

    <div class="flex h-[calc(100vh-65px)]">
      <!-- Sidebar -->
      <aside
        class="w-64 border-r border-gray-800 flex flex-col p-4 gap-2 overflow-y-auto"
      >
        <p
          class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
        >
          Videos
        </p>
        <div id="video-list" class="flex flex-col gap-1">
          <div class="text-xs text-gray-600 animate-pulse">Loading...</div>
        </div>

        <div class="mt-3 pt-3 border-t border-gray-800">
          <p
            class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
          >
            Pipeline
          </p>
          <div id="pipeline-status" class="space-y-2 text-xs"></div>
        </div>

        <div class="mt-auto pt-4 border-t border-gray-800">
          <button
            onclick="showTab('ingest')"
            class="w-full text-left text-xs text-gray-500 hover:text-white flex items-center gap-2 py-2 px-2 rounded hover:bg-gray-800 transition"
          >
            <i data-lucide="upload" class="w-3 h-3"></i> Ingest / Re-index
          </button>
        </div>
      </aside>

      <!-- Main content -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Tabs -->
        <div class="flex border-b border-gray-800 px-6">
          <button
            onclick="showTab('search')"
            id="tab-search"
            class="tab-active px-4 py-3 text-sm font-medium transition"
          >
            Search
          </button>
          <button
            onclick="showTab('ask')"
            id="tab-ask"
            class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-white transition"
          >
            Ask
          </button>
          <button
            onclick="showTab('timeline')"
            id="tab-timeline"
            class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-white transition"
          >
            Timeline
          </button>
          <button
            onclick="showTab('summary')"
            id="tab-summary"
            class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-white transition"
          >
            Summary
          </button>
          <button
            onclick="showTab('ingest')"
            id="tab-ingest"
            class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-white transition"
          >
            Ingest
          </button>
        </div>

        <!-- Tab panels -->
        <div class="flex-1 overflow-y-auto">
          <!-- SEARCH TAB -->
          <div id="panel-search" class="p-6">
            <div class="max-w-3xl mx-auto">
              <div class="flex gap-3 mb-6">
                <div class="flex-1 relative">
                  <i
                    data-lucide="search"
                    class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"
                  ></i>
                  <input
                    id="search-input"
                    type="text"
                    placeholder="Search across all videos... e.g. 'person in dark jacket'"
                    class="w-full bg-gray-900 border border-gray-700 rounded-lg pl-10 pr-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition"
                    onkeydown="if (event.key === 'Enter') doSearch();"
                  />
                </div>
                <select
                  id="search-video-filter"
                  class="bg-gray-900 border border-gray-700 rounded-lg px-3 py-3 text-sm focus:outline-none focus:border-indigo-500"
                >
                  <option value="">All videos</option>
                </select>
                <button
                  onclick="doSearch()"
                  class="bg-indigo-600 hover:bg-indigo-500 px-5 py-3 rounded-lg text-sm font-medium transition flex items-center gap-2"
                >
                  <span>Search</span>
                </button>
              </div>
              <div id="search-results" class="space-y-3"></div>
            </div>
          </div>

          <!-- ASK TAB -->
          <div id="panel-ask" class="p-6 hidden">
            <div class="max-w-3xl mx-auto">
              <div class="glass rounded-xl p-4 mb-6">
                <p class="text-xs text-gray-400 mb-3">
                  Ask anything about your video footage. The AI will retrieve
                  relevant moments and answer based on what it found.
                </p>
                <div class="flex gap-3">
                  <div class="flex-1">
                    <textarea
                      id="ask-input"
                      rows="2"
                      placeholder="e.g. 'What vehicles were seen near the entrance?' or 'Was there anything suspicious?'"
                      class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition resize-none"
                    ></textarea>
                  </div>
                </div>
                <div class="flex gap-3 mt-3">
                  <select
                    id="ask-video-filter"
                    class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                  >
                    <option value="">All videos</option>
                  </select>
                  <button
                    onclick="doAsk()"
                    class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                  >
                    <i data-lucide="sparkles" class="w-4 h-4"></i> Ask
                  </button>
                </div>
              </div>
              <div id="ask-results"></div>
            </div>
          </div>

          <!-- TIMELINE TAB -->
          <div id="panel-timeline" class="p-6 hidden">
            <div class="max-w-4xl mx-auto">
              <div class="flex gap-3 mb-6">
                <select
                  id="timeline-video-select"
                  class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-3 text-sm focus:outline-none focus:border-indigo-500"
                >
                  <option value="">Select a video...</option>
                </select>
                <button
                  onclick="doTimeline()"
                  class="bg-indigo-600 hover:bg-indigo-500 px-5 py-3 rounded-lg text-sm font-medium transition"
                >
                  Load Timeline
                </button>
              </div>
              <div id="timeline-results"></div>
            </div>
          </div>

          <!-- SUMMARY TAB -->
          <div id="panel-summary" class="p-6 hidden">
            <div class="max-w-3xl mx-auto">
              <div class="flex gap-3 mb-6">
                <select
                  id="summary-video-select"
                  class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-3 text-sm focus:outline-none focus:border-indigo-500"
                >
                  <option value="">Select a video...</option>
                </select>
                <button
                  onclick="doSummary(false)"
                  class="bg-indigo-600 hover:bg-indigo-500 px-5 py-3 rounded-lg text-sm font-medium transition"
                >
                  Get Summary
                </button>
                <button
                  onclick="doSummary(true)"
                  class="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg text-sm font-medium transition flex items-center gap-2"
                >
                  <i data-lucide="refresh-cw" class="w-3 h-3"></i> Regenerate
                </button>
              </div>
              <div id="summary-results"></div>
            </div>
          </div>

          <!-- INGEST TAB -->
          <div id="panel-ingest" class="p-6 hidden">
            <div class="max-w-2xl mx-auto space-y-4">
              <div class="glass rounded-xl p-5">
                <h3 class="text-sm font-semibold mb-1">Re-index Captions</h3>
                <p class="text-xs text-gray-400 mb-4">
                  Embed any captions that haven't been vectorized yet. Safe to
                  run multiple times.
                </p>
                <button
                  onclick="doReindex()"
                  class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                >
                  <i data-lucide="database" class="w-4 h-4"></i> Run Re-index
                </button>
                <div
                  id="reindex-result"
                  class="mt-3 text-sm text-gray-400"
                ></div>
              </div>
              <div class="glass rounded-xl p-5">
                <h3 class="text-sm font-semibold mb-1">
                  Generate All Summaries
                </h3>
                <p class="text-xs text-gray-400 mb-4">
                  Create summaries for every video that has captions. Uses
                  cached versions unless forced.
                </p>
                <div class="flex gap-3">
                  <button
                    onclick="doSummarizeAll(false)"
                    class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg text-sm font-medium transition"
                  >
                    Summarize All
                  </button>
                  <button
                    onclick="doSummarizeAll(true)"
                    class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                  >
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> Force
                    Regenerate
                  </button>
                </div>
                <div
                  id="summarize-all-result"
                  class="mt-3 text-sm text-gray-400"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const API = "/api/v1";
      let allVideos = [];

      // ── Utilities ──────────────────────────────────────────────────────────────────

      function fmt(s) {
        return `${Math.floor(s / 60)}:${String(Math.floor(s % 60)).padStart(2, "0")}`;
      }

      function spinner() {
        return `<div class="flex items-center gap-2 text-gray-500 text-sm py-8 justify-center">
    <svg class="spinner w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
    </svg>
    Processing...
  </div>`;
      }

      function errorBox(msg) {
        return `<div class="bg-red-950 border border-red-800 rounded-lg p-4 text-sm text-red-300">${msg}</div>`;
      }

      async function apiFetch(path, opts = {}) {
        const res = await fetch(API + path, opts);
        if (!res.ok) {
          const err = await res
            .json()
            .catch(() => ({ detail: res.statusText }));
          throw new Error(err.detail || res.statusText);
        }
        return res.json();
      }

      // ── Tabs ───────────────────────────────────────────────────────────────────────

      function showTab(name) {
        ["search", "ask", "timeline", "summary", "ingest"].forEach((t) => {
          document.getElementById(`panel-${t}`).classList.add("hidden");
          const tab = document.getElementById(`tab-${t}`);
          tab.classList.remove("tab-active");
          tab.classList.add("text-gray-500");
        });
        document.getElementById(`panel-${name}`).classList.remove("hidden");
        const activeTab = document.getElementById(`tab-${name}`);
        activeTab.classList.add("tab-active");
        activeTab.classList.remove("text-gray-500");
      }

      // ── Init ───────────────────────────────────────────────────────────────────────

      async function init() {
        // Health check
        try {
          await apiFetch("/health");
          document.getElementById("status-dot").className =
            "w-2 h-2 rounded-full bg-green-500";
          document.getElementById("status-text").textContent = "API online";
        } catch {
          document.getElementById("status-dot").className =
            "w-2 h-2 rounded-full bg-red-500";
          document.getElementById("status-text").textContent = "API offline";
        }

        // Load videos
        try {
          const data = await apiFetch("/videos");
          allVideos = data.videos;
          renderSidebar(allVideos);
          populateVideoFilters(allVideos);
        } catch (e) {
          document.getElementById("video-list").innerHTML =
            `<div class="text-xs text-red-400">${e.message}</div>`;
        }
      }

      function renderSidebar(videos) {
        const el = document.getElementById("video-list");
        if (!videos.length) {
          el.innerHTML = `<div class="text-xs text-gray-600">No videos ingested yet</div>`;
          return;
        }
        el.innerHTML = videos
          .map(
            (v) => `
    <button onclick="selectVideo('${v.video_filename}')"
      class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-800 transition group">
      <div class="flex items-center gap-2">
        <i data-lucide="film" class="w-3 h-3 text-indigo-400 shrink-0"></i>
        <span class="text-xs font-medium truncate">${v.video_filename}</span>
      </div>
      <div class="flex gap-2 mt-1 ml-5">
        <span class="text-xs text-gray-600">${v.caption_count} scenes</span>
        ${v.has_summary ? '<span class="text-xs text-green-600">✓ summary</span>' : ""}
      </div>
    </button>
  `,
          )
          .join("");
        lucide.createIcons();
      }

      function populateVideoFilters(videos) {
        [
          "search-video-filter",
          "ask-video-filter",
          "timeline-video-select",
          "summary-video-select",
        ].forEach((id) => {
          const el = document.getElementById(id);
          const isSelect = id.includes("select");
          if (!isSelect) el.innerHTML = '<option value="">All videos</option>';
          else el.innerHTML = '<option value="">Select a video...</option>';
          videos.forEach((v) => {
            const opt = document.createElement("option");
            opt.value = v.video_filename;
            opt.textContent = v.video_filename;
            el.appendChild(opt);
          });
        });
      }

      function selectVideo(filename) {
        // Pre-select this video in all filters and switch to timeline
        [
          "search-video-filter",
          "ask-video-filter",
          "timeline-video-select",
          "summary-video-select",
        ].forEach((id) => {
          document.getElementById(id).value = filename;
        });
        showTab("timeline");
        doTimeline();
      }

      // ── Search ─────────────────────────────────────────────────────────────────────

      async function doSearch() {
        const q = document.getElementById("search-input").value.trim();
        if (!q) return;
        const video = document.getElementById("search-video-filter").value;
        const el = document.getElementById("search-results");
        el.innerHTML = spinner();

        try {
          const params = new URLSearchParams({ q, top_k: 12 });
          if (video) params.set("video_filename", video);
          const data = await apiFetch(`/search?${params}`);

          if (!data.results.length) {
            el.innerHTML = `<div class="text-sm text-gray-500 text-center py-8">No results found for "${q}"</div>`;
            return;
          }

          el.innerHTML = `
      <p class="text-xs text-gray-500 mb-4">${data.count} results for <span class="text-white">"${q}"</span></p>
      <div class="grid gap-3">
        ${data.results.map((r) => resultCard(r)).join("")}
      </div>
    `;
          lucide.createIcons();
        } catch (e) {
          el.innerHTML = errorBox(e.message);
        }
      }

      function resultCard(r) {
        const score = Math.round(r.score * 100);
        const scoreColor =
          score > 80
            ? "text-green-400"
            : score > 60
              ? "text-yellow-400"
              : "text-gray-500";
        return `
    <div class="result-card glass rounded-xl p-4 cursor-pointer fade-in" onclick="expandCaption(this)">
      <div class="flex items-start justify-between gap-4">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-2">
            <i data-lucide="film" class="w-3 h-3 text-indigo-400 shrink-0"></i>
            <span class="text-xs text-indigo-300 font-medium truncate">${r.video_filename}</span>
            <span class="text-xs text-gray-600">@</span>
            <span class="text-xs text-gray-400">${fmt(r.second)}</span>
            <span class="text-xs ${scoreColor} ml-auto">${score}% match</span>
          </div>
          <p class="text-xs text-gray-400 line-clamp-2 caption-preview">${r.caption}</p>
          <p class="text-xs text-gray-300 hidden caption-full">${r.caption}</p>
        </div>
        ${
          r.keyframe_path
            ? `
          <img src="/api/v1/keyframe?path=${encodeURIComponent(r.keyframe_path)}"
            class="w-24 h-16 object-cover rounded-lg shrink-0 bg-gray-800"
            onerror="this.style.display='none'" />
        `
            : ""
        }
      </div>
    </div>
  `;
      }

      function expandCaption(card) {
        const preview = card.querySelector(".caption-preview");
        const full = card.querySelector(".caption-full");
        if (preview && full) {
          preview.classList.toggle("hidden");
          full.classList.toggle("hidden");
        }
      }

      // ── Ask ────────────────────────────────────────────────────────────────────────

      async function doAsk() {
        const q = document.getElementById("ask-input").value.trim();
        if (!q) return;
        const video = document.getElementById("ask-video-filter").value;
        const el = document.getElementById("ask-results");
        el.innerHTML = spinner();

        try {
          const body = { question: q };
          if (video) body.video_filename = video;
          const data = await apiFetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          el.innerHTML = `
      <div class="glass rounded-xl p-5 mb-4 fade-in">
        <div class="flex items-center gap-2 mb-3">
          <i data-lucide="sparkles" class="w-4 h-4 text-indigo-400"></i>
          <span class="text-sm font-medium">Answer</span>
        </div>
        <p class="text-sm text-gray-200 leading-relaxed">${data.answer}</p>
      </div>
      ${
        data.sources.length
          ? `
        <div class="mb-2 text-xs text-gray-500">Based on ${data.sources.length} source moments:</div>
        <div class="grid gap-3">
          ${data.sources.map((r) => resultCard(r)).join("")}
        </div>
      `
          : ""
      }
    `;
          lucide.createIcons();
        } catch (e) {
          el.innerHTML = errorBox(e.message);
        }
      }

      // ── Timeline ───────────────────────────────────────────────────────────────────

      async function doTimeline() {
        const video = document.getElementById("timeline-video-select").value;
        if (!video) return;
        const el = document.getElementById("timeline-results");
        el.innerHTML = spinner();

        try {
          const data = await apiFetch(`/timeline/${encodeURIComponent(video)}`);
          el.innerHTML = `
      <p class="text-xs text-gray-500 mb-4">${data.count} scene changes in <span class="text-white">${video}</span></p>
      <div class="relative">
        <div class="absolute left-6 top-0 bottom-0 w-px bg-gray-800"></div>
        <div class="space-y-4">
          ${data.timeline
            .map(
              (item, i) => `
            <div class="flex gap-4 fade-in" style="animation-delay:${i * 30}ms">
              <div class="relative z-10 w-12 h-12 shrink-0 flex items-center justify-center">
                <div class="w-3 h-3 rounded-full bg-indigo-600 border-2 border-gray-950"></div>
              </div>
              <div class="flex-1 glass rounded-xl p-4 mb-0 cursor-pointer result-card" onclick="expandCaption(this)">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-mono text-indigo-300">${fmt(item.second)}</span>
                  <span class="text-xs text-gray-600">${item.second.toFixed(1)}s</span>
                </div>
                <p class="text-xs text-gray-400 line-clamp-2 caption-preview">${item.caption}</p>
                <p class="text-xs text-gray-300 hidden caption-full">${item.caption}</p>
                ${
                  item.keyframe_path
                    ? `
                  <img src="/api/v1/keyframe?path=${encodeURIComponent(item.keyframe_path)}"
                    class="mt-3 w-full max-w-xs h-32 object-cover rounded-lg bg-gray-800"
                    onerror="this.style.display='none'" />
                `
                    : ""
                }
              </div>
            </div>
          `,
            )
            .join("")}
        </div>
      </div>
    `;
        } catch (e) {
          el.innerHTML = errorBox(e.message);
        }
      }

      // ── Summary ────────────────────────────────────────────────────────────────────

      async function doSummary(force = false) {
        const video = document.getElementById("summary-video-select").value;
        if (!video) return;
        const el = document.getElementById("summary-results");
        el.innerHTML = spinner();

        try {
          let data;
          if (force) {
            data = await apiFetch(
              `/summarize/${encodeURIComponent(video)}?force=true`,
              { method: "POST" },
            );
          } else {
            try {
              data = await apiFetch(`/summary/${encodeURIComponent(video)}`);
              // normalize field name
              if (data.summary_text) data.summary = data.summary_text;
            } catch (e) {
              if (e.message.includes("No summary")) {
                data = await apiFetch(
                  `/summarize/${encodeURIComponent(video)}`,
                  { method: "POST" },
                );
              } else throw e;
            }
          }

          el.innerHTML = `
      <div class="glass rounded-xl p-5 fade-in">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <i data-lucide="file-text" class="w-4 h-4 text-indigo-400"></i>
            <span class="text-sm font-medium">${video}</span>
          </div>
          <div class="flex gap-3 text-xs text-gray-500">
            <span>${data.caption_count} scenes</span>
            <span>${fmt(data.duration_seconds)} duration</span>
            <span class="text-gray-600">${data.model_name}</span>
          </div>
        </div>
        <pre class="text-xs text-gray-300 leading-relaxed">${data.summary || data.summary_text}</pre>
      </div>
    `;
          lucide.createIcons();
        } catch (e) {
          el.innerHTML = errorBox(e.message);
        }
      }

      // ── Ingest actions ─────────────────────────────────────────────────────────────

      async function doReindex() {
        const el = document.getElementById("reindex-result");
        el.textContent = "Running...";
        try {
          const data = await apiFetch("/index", { method: "POST" });
          el.textContent = `✓ Indexed ${data.indexed} new caption(s).`;
          el.className = "mt-3 text-sm text-green-400";
        } catch (e) {
          el.textContent = `Error: ${e.message}`;
          el.className = "mt-3 text-sm text-red-400";
        }
      }

      async function doSummarizeAll(force = false) {
        const el = document.getElementById("summarize-all-result");
        el.textContent = "Running... this may take a few minutes.";
        try {
          const data = await apiFetch(`/summarize-all?force=${force}`, {
            method: "POST",
          });
          el.textContent = `✓ Summarized ${data.summarized} video(s): ${data.videos.join(", ")}`;
          el.className = "mt-3 text-sm text-green-400";
          await init(); // refresh sidebar
        } catch (e) {
          el.textContent = `Error: ${e.message}`;
          el.className = "mt-3 text-sm text-red-400";
        }
      }

      const TERMINAL_STATES = new Set(["completed", "skipped", "failed"]);
      let _pollTimer = null;

      async function pollPipelineStatus() {
        try {
          const data = await apiFetch("/status");
          const el = document.getElementById("pipeline-status");
          if (!el) return;

          if (!data.statuses.length) {
            el.innerHTML = '<div class="text-gray-600">No jobs yet</div>';
            return;
          }

          const colors = {
            completed: "text-green-400",
            running: "text-yellow-400",
            failed: "text-red-400",
            pending: "text-gray-500",
            skipped: "text-gray-600",
          };

          el.innerHTML = data.statuses
            .map((s) => {
              const color = colors[s.status] || "text-gray-400";
              const pct =
                s.progress_pct != null ? " " + s.progress_pct + "%" : "";
              const errMsg = s.last_error
                ? s.last_error.slice(0, 50) + "..."
                : "";
              const err = s.last_error
                ? '<div class="text-red-500 truncate" title="' +
                  s.last_error +
                  '">⚠ ' +
                  errMsg +
                  "</div>"
                : "";
              const bar =
                s.status === "running" && s.progress_pct != null
                  ? '<div class="w-full bg-gray-800 rounded-full h-1 mt-1"><div class="bg-yellow-400 h-1 rounded-full" style="width:' +
                    s.progress_pct +
                    '%"></div></div>'
                  : "";
              return (
                '<div class="glass rounded-lg p-2"><div class="flex justify-between items-center"><span class="truncate font-medium" style="max-width:120px" title="' +
                s.video_filename +
                '">' +
                s.video_filename +
                '</span><span class="' +
                color +
                ' font-mono">' +
                s.status +
                pct +
                '</span></div><div class="text-gray-600 mt-0.5">' +
                s.scenes_captioned +
                "/" +
                s.scenes_detected +
                " scenes" +
                (s.current_second != null
                  ? " @ " + s.current_second.toFixed(1) + "s"
                  : "") +
                "</div>" +
                bar +
                err +
                "</div>"
              );
            })
            .join("");

          // Stop polling once every job is in a terminal state — no more requests needed
          const allDone = data.statuses.every((s) =>
            TERMINAL_STATES.has(s.status),
          );
          if (allDone && _pollTimer !== null) {
            clearInterval(_pollTimer);
            _pollTimer = null;
          }
        } catch (e) {
          /* non-critical */
        }
      }

      function startStatusPolling() {
        pollPipelineStatus(); // immediate first call
        _pollTimer = setInterval(pollPipelineStatus, 5000);
      }

      // ── Boot ───────────────────────────────────────────────────────────────────────
      lucide.createIcons();
      init();
      startStatusPolling();
    </script>
  </body>
</html>
