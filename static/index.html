<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VideoRAG — Search anything, anytime</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      * {
        font-family: "Inter", sans-serif;
      }
      .glass {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .result-card:hover {
        transform: translateY(-2px);
        transition: all 0.2s;
      }
      .tab-active {
        border-bottom: 2px solid #6366f1;
        color: #6366f1;
      }
      .spinner {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      ::-webkit-scrollbar {
        width: 4px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #374151;
        border-radius: 2px;
      }
    </style>
  </head>
  <body class="bg-gray-950 text-gray-100 min-h-screen">
    <!-- Header -->
    <header
      class="border-b border-gray-800 px-6 py-4 flex items-center justify-between sticky top-0 bg-gray-950 z-50"
    >
      <div class="flex items-center gap-3">
        <div
          class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center"
        >
          <i data-lucide="video" class="w-4 h-4 text-white"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold tracking-tight">VideoRAG</h1>
          <p class="text-xs text-gray-500">Search anything, anytime</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="status-dot" class="w-2 h-2 rounded-full bg-gray-600"></span>
        <span id="status-text" class="text-xs text-gray-500">Checking...</span>
      </div>
    </header>

    <div class="flex h-[calc(100vh-65px)]">
      <!-- Sidebar -->
      <aside
        class="w-64 border-r border-gray-800 flex flex-col p-4 gap-2 overflow-y-auto"
      >
        <p
          class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
        >
          Videos
        </p>
        <div id="video-list" class="flex flex-col gap-1">
          <div class="text-xs text-gray-600 animate-pulse">Loading...</div>
        </div>

        <div class="mt-3 pt-3 border-t border-gray-800">
          <p
            class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2"
          >
            Pipeline
          </p>
          <div id="pipeline-status" class="space-y-2 text-xs"></div>
        </div>

        <div class="mt-auto pt-4 border-t border-gray-800">
          <button
            onclick="showTab('ingest')"
            class="w-full text-left text-xs text-gray-500 hover:text-white flex items-center gap-2 py-2 px-2 rounded hover:bg-gray-800 transition"
          >
            <i data-lucide="upload" class="w-3 h-3"></i> Ingest / Re-index
          </button>
        </div>
      </aside>

      <!-- Main content -->
      <main class="flex-1 flex flex-col overflow-hidden">
        <!-- Tabs -->
        <div class="flex border-b border-gray-800 px-6">
          <button
            onclick="showTab('search')"
            id="tab-search"
            class="tab-active px-4 py-3 text-sm font-medium transition"
          >
            Search
          </button>
          <button
            onclick="showTab('ask')"
            id="tab-ask"
            class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-white transition"
          >
            Ask
          </button>
          <button
            onclick="showTab('timeline')"
            id="tab-timeline"
            class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-white transition"
          >
            Timeline
          </button>
          <button
            onclick="showTab('summary')"
            id="tab-summary"
            class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-white transition"
          >
            Summary
          </button>
          <button
            onclick="showTab('detections')"
            id="tab-detections"
            class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-white transition"
          >
            Detections
          </button>
          <button
            onclick="showTab('ingest')"
            id="tab-ingest"
            class="px-4 py-3 text-sm font-medium text-gray-500 hover:text-white transition"
          >
            Ingest
          </button>
        </div>

        <!-- Tab panels -->
        <div class="flex-1 overflow-y-auto">
          <!-- SEARCH TAB -->
          <div id="panel-search" class="p-6">
            <div class="max-w-4xl mx-auto">
              <!-- Search bar -->
              <div class="mb-4">
                <div class="relative">
                  <i
                    data-lucide="search"
                    class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none"
                  ></i>
                  <input
                    id="search-input"
                    type="text"
                    autocomplete="off"
                    placeholder='Search... try "blue car", "person entered", "van dwell"'
                    class="w-full bg-gray-950 border border-gray-700 rounded-xl pl-11 pr-4 py-3.5 text-sm focus:outline-none focus:border-indigo-500 transition placeholder-gray-600"
                    oninput="onSearchInput(this.value)"
                    onkeydown="if (event.key === 'Enter') doSearch();"
                  />
                </div>
                <!-- Auto-detected filter chips -->
                <div
                  id="filter-chips"
                  class="flex flex-wrap gap-2 mt-3 min-h-[28px]"
                ></div>
                <!-- Suggestion pills -->
                <div id="search-suggestions" class="flex flex-wrap gap-2 mt-3">
                  <span class="text-xs text-gray-600 self-center mr-1"
                    >Try:</span
                  >
                  <button
                    onclick="useQuery('blue car')"
                    class="text-xs px-3 py-1 rounded-full border border-gray-700 text-gray-400 hover:border-indigo-500 hover:text-indigo-300 transition"
                  >
                    blue car
                  </button>
                  <button
                    onclick="useQuery('person with backpack')"
                    class="text-xs px-3 py-1 rounded-full border border-gray-700 text-gray-400 hover:border-indigo-500 hover:text-indigo-300 transition"
                  >
                    person with backpack
                  </button>
                  <button
                    onclick="useQuery('car entered')"
                    class="text-xs px-3 py-1 rounded-full border border-gray-700 text-gray-400 hover:border-indigo-500 hover:text-indigo-300 transition"
                  >
                    car entered
                  </button>
                  <button
                    onclick="useQuery('vehicle dwell')"
                    class="text-xs px-3 py-1 rounded-full border border-gray-700 text-gray-400 hover:border-indigo-500 hover:text-indigo-300 transition"
                  >
                    vehicle dwell
                  </button>
                  <button
                    onclick="useQuery('Toyota sedan')"
                    class="text-xs px-3 py-1 rounded-full border border-gray-700 text-gray-400 hover:border-indigo-500 hover:text-indigo-300 transition"
                  >
                    Toyota sedan
                  </button>
                </div>
              </div>

              <!-- Filter bar: video + type + event + time -->
              <div class="flex flex-wrap gap-2 mb-5 items-center">
                <select
                  id="search-video-filter"
                  class="bg-gray-950 border border-gray-700 rounded-lg px-3 py-1.5 text-xs text-gray-300 focus:outline-none focus:border-indigo-500 transition"
                >
                  <option value="">All videos</option>
                </select>

                <div class="flex items-center gap-1.5 flex-wrap">
                  <span class="text-xs text-gray-600">Type:</span>
                  <button
                    data-cls=""
                    onclick="toggleClassFilter(this)"
                    class="class-pill text-xs px-2.5 py-1 rounded-full border border-indigo-500 text-indigo-300 bg-indigo-500/10 transition"
                  >
                    all
                  </button>
                  <button
                    data-cls="person"
                    onclick="toggleClassFilter(this)"
                    class="class-pill text-xs px-2.5 py-1 rounded-full border border-gray-700 text-gray-500 hover:border-gray-500 transition"
                  >
                    person
                  </button>
                  <button
                    data-cls="car"
                    onclick="toggleClassFilter(this)"
                    class="class-pill text-xs px-2.5 py-1 rounded-full border border-gray-700 text-gray-500 hover:border-gray-500 transition"
                  >
                    car
                  </button>
                  <button
                    data-cls="truck"
                    onclick="toggleClassFilter(this)"
                    class="class-pill text-xs px-2.5 py-1 rounded-full border border-gray-700 text-gray-500 hover:border-gray-500 transition"
                  >
                    truck
                  </button>
                  <button
                    data-cls="van"
                    onclick="toggleClassFilter(this)"
                    class="class-pill text-xs px-2.5 py-1 rounded-full border border-gray-700 text-gray-500 hover:border-gray-500 transition"
                  >
                    van
                  </button>
                  <button
                    data-cls="motorcycle"
                    onclick="toggleClassFilter(this)"
                    class="class-pill text-xs px-2.5 py-1 rounded-full border border-gray-700 text-gray-500 hover:border-gray-500 transition"
                  >
                    motorcycle
                  </button>
                </div>

                <div class="flex items-center gap-1.5 flex-wrap">
                  <span class="text-xs text-gray-600">Event:</span>
                  <button
                    data-ev=""
                    onclick="toggleEventFilter(this)"
                    class="event-pill text-xs px-2.5 py-1 rounded-full border border-indigo-500 text-indigo-300 bg-indigo-500/10 transition"
                  >
                    any
                  </button>
                  <button
                    data-ev="entry"
                    onclick="toggleEventFilter(this)"
                    class="event-pill text-xs px-2.5 py-1 rounded-full border border-gray-700 text-gray-500 hover:border-gray-500 transition"
                  >
                    entry
                  </button>
                  <button
                    data-ev="exit"
                    onclick="toggleEventFilter(this)"
                    class="event-pill text-xs px-2.5 py-1 rounded-full border border-gray-700 text-gray-500 hover:border-gray-500 transition"
                  >
                    exit
                  </button>
                  <button
                    data-ev="dwell"
                    onclick="toggleEventFilter(this)"
                    class="event-pill text-xs px-2.5 py-1 rounded-full border border-gray-700 text-gray-500 hover:border-gray-500 transition"
                  >
                    dwell
                  </button>
                </div>

                <div class="flex items-center gap-1.5 ml-auto">
                  <span class="text-xs text-gray-600">From</span>
                  <input
                    id="search-min-sec"
                    type="number"
                    min="0"
                    placeholder="0"
                    step="1"
                    class="w-16 bg-gray-950 border border-gray-700 rounded-lg px-2 py-1 text-xs text-gray-300 focus:outline-none focus:border-indigo-500 transition"
                  />
                  <span class="text-xs text-gray-600">to</span>
                  <input
                    id="search-max-sec"
                    type="number"
                    min="0"
                    placeholder="∞"
                    step="1"
                    class="w-16 bg-gray-950 border border-gray-700 rounded-lg px-2 py-1 text-xs text-gray-300 focus:outline-none focus:border-indigo-500 transition"
                  />
                  <span class="text-xs text-gray-600">sec</span>
                  <button
                    onclick="doSearch()"
                    class="ml-2 bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded-lg text-xs font-semibold transition flex items-center gap-1.5"
                  >
                    <i data-lucide="search" class="w-3 h-3"></i> Search
                  </button>
                </div>
              </div>

              <!-- Results -->
              <div id="search-results"></div>
            </div>
          </div>

          <!-- ASK TAB -->
          <div id="panel-ask" class="p-6 hidden">
            <div class="max-w-3xl mx-auto">
              <div class="glass rounded-xl p-4 mb-6">
                <p class="text-xs text-gray-400 mb-3">
                  Ask anything about your video footage. The AI will retrieve
                  relevant moments and answer based on what it found.
                </p>
                <div class="flex gap-3">
                  <div class="flex-1">
                    <textarea
                      id="ask-input"
                      rows="2"
                      placeholder="e.g. 'What vehicles were seen near the entrance?' or 'Was there anything suspicious?'"
                      class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-indigo-500 transition resize-none"
                    ></textarea>
                  </div>
                </div>
                <div class="flex gap-3 mt-3">
                  <select
                    id="ask-video-filter"
                    class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                  >
                    <option value="">All videos</option>
                  </select>
                  <button
                    onclick="doAsk()"
                    class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                  >
                    <i data-lucide="sparkles" class="w-4 h-4"></i> Ask
                  </button>
                </div>
              </div>
              <div id="ask-results"></div>
            </div>
          </div>

          <!-- TIMELINE TAB -->
          <div id="panel-timeline" class="p-6 hidden">
            <div class="max-w-4xl mx-auto">
              <div class="flex gap-3 mb-6">
                <select
                  id="timeline-video-select"
                  class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-3 text-sm focus:outline-none focus:border-indigo-500"
                >
                  <option value="">Select a video...</option>
                </select>
                <button
                  onclick="doTimeline()"
                  class="bg-indigo-600 hover:bg-indigo-500 px-5 py-3 rounded-lg text-sm font-medium transition"
                >
                  Load Timeline
                </button>
              </div>
              <div id="timeline-results"></div>
            </div>
          </div>

          <!-- SUMMARY TAB -->
          <div id="panel-summary" class="p-6 hidden">
            <div class="max-w-3xl mx-auto">
              <div class="flex gap-3 mb-6">
                <select
                  id="summary-video-select"
                  class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-3 text-sm focus:outline-none focus:border-indigo-500"
                >
                  <option value="">Select a video...</option>
                </select>
                <button
                  onclick="doSummary(false)"
                  class="bg-indigo-600 hover:bg-indigo-500 px-5 py-3 rounded-lg text-sm font-medium transition"
                >
                  Get Summary
                </button>
                <button
                  onclick="doSummary(true)"
                  class="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg text-sm font-medium transition flex items-center gap-2"
                >
                  <i data-lucide="refresh-cw" class="w-3 h-3"></i> Regenerate
                </button>
              </div>
              <div id="summary-results"></div>
            </div>
          </div>

          <!-- DETECTIONS TAB -->
          <div id="panel-detections" class="p-6 hidden">
            <div class="max-w-4xl mx-auto">
              <div class="flex gap-3 mb-4">
                <select
                  id="detections-video-select"
                  class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-3 text-sm focus:outline-none focus:border-indigo-500"
                >
                  <option value="">Select a video...</option>
                </select>
                <select
                  id="detections-mode"
                  class="bg-gray-900 border border-gray-700 rounded-lg px-3 py-3 text-sm focus:outline-none focus:border-indigo-500"
                >
                  <option value="tracks">Tracks (best crops)</option>
                  <option value="detections">All detections</option>
                  <option value="events">Track events</option>
                </select>
                <select
                  id="detections-class-filter"
                  class="bg-gray-900 border border-gray-700 rounded-lg px-3 py-3 text-sm focus:outline-none focus:border-indigo-500"
                >
                  <option value="">All classes</option>
                  <option value="person">Person</option>
                  <option value="car">Car</option>
                  <option value="truck">Truck</option>
                  <option value="bus">Bus</option>
                  <option value="motorcycle">Motorcycle</option>
                  <option value="bicycle">Bicycle</option>
                </select>
                <button
                  onclick="doDetections()"
                  class="bg-indigo-600 hover:bg-indigo-500 px-5 py-3 rounded-lg text-sm font-medium transition"
                >
                  Load
                </button>
              </div>
              <div id="detections-results"></div>
            </div>
          </div>

          <!-- INGEST TAB -->
          <div id="panel-ingest" class="p-6 hidden">
            <div class="max-w-2xl mx-auto space-y-4">
              <div class="glass rounded-xl p-5">
                <h3 class="text-sm font-semibold mb-1">
                  Phase 6B: Extract Object Attributes
                </h3>
                <p class="text-xs text-gray-400 mb-4">
                  Run minicpm-v on the best crop per tracked object to extract
                  color, type, clothing, and other attributes. Upgrades RAG text
                  for richer search queries like "red van" or "person in dark
                  jacket".
                </p>
                <div class="flex gap-3 mb-3">
                  <select
                    id="attr-video-select"
                    class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-500"
                  >
                    <option value="">Select a video...</option>
                  </select>
                  <button
                    onclick="doExtractAttributes()"
                    class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                  >
                    <i data-lucide="sparkles" class="w-4 h-4"></i> Extract
                    Attributes
                  </button>
                </div>
                <div id="attr-result" class="mt-3 text-sm text-gray-400"></div>
              </div>
              <div class="glass rounded-xl p-5">
                <h3 class="text-sm font-semibold mb-1">Re-index Captions</h3>
                <p class="text-xs text-gray-400 mb-4">
                  Embed any captions that haven't been vectorized yet. Safe to
                  run multiple times.
                </p>
                <button
                  onclick="doReindex()"
                  class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                >
                  <i data-lucide="database" class="w-4 h-4"></i> Run Re-index
                </button>
                <div
                  id="reindex-result"
                  class="mt-3 text-sm text-gray-400"
                ></div>
              </div>
              <div class="glass rounded-xl p-5">
                <h3 class="text-sm font-semibold mb-1">
                  Generate All Summaries
                </h3>
                <p class="text-xs text-gray-400 mb-4">
                  Create summaries for every video that has captions. Uses
                  cached versions unless forced.
                </p>
                <div class="flex gap-3">
                  <button
                    onclick="doSummarizeAll(false)"
                    class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-lg text-sm font-medium transition"
                  >
                    Summarize All
                  </button>
                  <button
                    onclick="doSummarizeAll(true)"
                    class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"
                  >
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> Force
                    Regenerate
                  </button>
                </div>
                <div
                  id="summarize-all-result"
                  class="mt-3 text-sm text-gray-400"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const API = "/api/v1";
      let allVideos = [];

      // ── Utilities ──────────────────────────────────────────────────────────────────

      function fmt(s) {
        if (s == null || isNaN(s)) return "0:00";
        return `${Math.floor(s / 60)}:${String(Math.floor(s % 60)).padStart(2, "0")}`;
      }

      function spinner() {
        return `<div class="flex items-center gap-2 text-gray-500 text-sm py-8 justify-center">
          <svg class="spinner w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
          Processing...
        </div>`;
      }

      function errorBox(msg) {
        return `<div class="bg-red-950 border border-red-800 rounded-lg p-4 text-sm text-red-300">${msg}</div>`;
      }

      async function apiFetch(path, opts = {}) {
        const res = await fetch(API + path, opts);
        if (!res.ok) {
          const err = await res
            .json()
            .catch(() => ({ detail: res.statusText }));
          throw new Error(err.detail || res.statusText);
        }
        return res.json();
      }

      // ── Tabs ───────────────────────────────────────────────────────────────────────

      function showTab(name) {
        [
          "search",
          "ask",
          "timeline",
          "summary",
          "detections",
          "ingest",
        ].forEach((t) => {
          document.getElementById(`panel-${t}`).classList.add("hidden");
          const tab = document.getElementById(`tab-${t}`);
          tab.classList.remove("tab-active");
          tab.classList.add("text-gray-500");
        });
        document.getElementById(`panel-${name}`).classList.remove("hidden");
        const activeTab = document.getElementById(`tab-${name}`);
        activeTab.classList.add("tab-active");
        activeTab.classList.remove("text-gray-500");
      }

      // ── Init ───────────────────────────────────────────────────────────────────────

      async function init() {
        // Health check
        try {
          await apiFetch("/health");
          document.getElementById("status-dot").className =
            "w-2 h-2 rounded-full bg-green-500";
          document.getElementById("status-text").textContent = "API online";
        } catch {
          document.getElementById("status-dot").className =
            "w-2 h-2 rounded-full bg-red-500";
          document.getElementById("status-text").textContent = "API offline";
        }

        // Load videos
        try {
          const data = await apiFetch("/videos");
          allVideos = data.videos;
          renderSidebar(allVideos);
          populateVideoFilters(allVideos);
        } catch (e) {
          document.getElementById("video-list").innerHTML =
            `<div class="text-xs text-red-400">${e.message}</div>`;
        }
      }

      function renderSidebar(videos) {
        const el = document.getElementById("video-list");
        if (!videos.length) {
          el.innerHTML = `<div class="text-xs text-gray-600">No videos ingested yet</div>`;
          return;
        }
        el.innerHTML = videos
          .map(
            (v) => `
          <button onclick="selectVideo('${v.video_filename}')"
            class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-800 transition group">
            <div class="flex items-center gap-2">
              <i data-lucide="film" class="w-3 h-3 text-indigo-400 shrink-0"></i>
              <span class="text-xs font-medium truncate">${v.video_filename}</span>
            </div>
            <div class="flex gap-2 mt-1 ml-5">
              ${
                v.detection_count > 0
                  ? `<span class="text-xs text-indigo-500">${v.detection_count} detections</span>`
                  : `<span class="text-xs text-gray-600">${v.caption_count} scenes</span>`
              }
              ${v.has_summary ? '<span class="text-xs text-green-600">✓ summary</span>' : ""}
              <span class="text-xs text-gray-700">${v.processing_status}</span>
              ${v.phase_6b_completed ? '<span class="text-xs text-yellow-500">✓ attrs</span>' : ""}
            </div>
          </button>
        `,
          )
          .join("");
        lucide.createIcons();
      }

      function populateVideoFilters(videos) {
        [
          "search-video-filter",
          "ask-video-filter",
          "timeline-video-select",
          "summary-video-select",
          "detections-video-select",
          "attr-video-select",
        ].forEach((id) => {
          const el = document.getElementById(id);
          const isSelect = id.includes("select");
          if (!isSelect) el.innerHTML = '<option value="">All videos</option>';
          else el.innerHTML = '<option value="">Select a video...</option>';
          videos.forEach((v) => {
            const opt = document.createElement("option");
            opt.value = v.video_filename;
            opt.textContent = v.video_filename;
            el.appendChild(opt);
          });
        });
      }

      function selectVideo(filename) {
        // Pre-select this video in all filters and switch to timeline
        [
          "search-video-filter",
          "ask-video-filter",
          "timeline-video-select",
          "summary-video-select",
          "detections-video-select",
        ].forEach((id) => {
          document.getElementById(id).value = filename;
        });
        showTab("timeline");
        doTimeline();
      }

      // ── Search ─────────────────────────────────────────────────────────────────────

      // ── Smart Search ───────────────────────────────────────────────────────────────

      let activeClass = "";
      let activeEvent = "";

      const CLASS_KEYWORDS = {
        person: "person",
        people: "person",
        pedestrian: "person",
        man: "person",
        woman: "person",
        male: "person",
        female: "person",
        car: "car",
        sedan: "car",
        vehicle: "car",
        automobile: "car",
        auto: "car",
        truck: "truck",
        lorry: "truck",
        van: "van",
        bus: "bus",
        motorcycle: "motorcycle",
        motorbike: "motorcycle",
        bike: "motorcycle",
        bicycle: "bicycle",
      };
      const EVENT_KEYWORDS = {
        enter: "entry",
        entered: "entry",
        entry: "entry",
        arrived: "entry",
        appears: "entry",
        appear: "entry",
        exit: "exit",
        exited: "exit",
        left: "exit",
        departed: "exit",
        leave: "exit",
        leaving: "exit",
        dwell: "dwell",
        dwell: "dwell",
        loiter: "dwell",
        loitering: "dwell",
        waiting: "dwell",
        lingering: "dwell",
        standing: "dwell",
        stayed: "dwell",
      };
      const COLORS = [
        "red",
        "blue",
        "black",
        "white",
        "silver",
        "grey",
        "gray",
        "green",
        "yellow",
        "orange",
        "dark",
        "light",
        "dark-blue",
        "navy",
      ];

      function onSearchInput(val) {
        document.getElementById("search-suggestions").style.display = val
          ? "none"
          : "flex";
        parseQueryToChips(val);
      }

      function useQuery(q) {
        document.getElementById("search-input").value = q;
        onSearchInput(q);
        doSearch();
      }

      function parseQueryToChips(query) {
        const words = query.toLowerCase().split(/\s+/);
        const chips = [];

        let detectedClass = "";
        for (const w of words) {
          if (CLASS_KEYWORDS[w]) {
            detectedClass = CLASS_KEYWORDS[w];
            break;
          }
        }

        let detectedEvent = "";
        for (const w of words) {
          if (EVENT_KEYWORDS[w]) {
            detectedEvent = EVENT_KEYWORDS[w];
            break;
          }
        }

        let detectedColor = "";
        for (const w of words) {
          if (COLORS.includes(w)) {
            detectedColor = w;
            break;
          }
        }

        let detectedAfter = null,
          detectedBefore = null;
        const afterM = query.match(/(?:after|from)\s+(\d+)(?::(\d+))?/i);
        const beforeM = query.match(/(?:before|until)\s+(\d+)(?::(\d+))?/i);
        if (afterM)
          detectedAfter =
            parseInt(afterM[1]) * 60 + (afterM[2] ? parseInt(afterM[2]) : 0);
        if (beforeM)
          detectedBefore =
            parseInt(beforeM[1]) * 60 + (beforeM[2] ? parseInt(beforeM[2]) : 0);

        if (detectedClass)
          chips.push(
            `<span class="flex items-center gap-1 text-xs px-2.5 py-1 rounded-full bg-indigo-500/15 border border-indigo-500/40 text-indigo-300"><i data-lucide="box" class="w-3 h-3"></i>${detectedClass}</span>`,
          );
        if (detectedEvent)
          chips.push(
            `<span class="flex items-center gap-1 text-xs px-2.5 py-1 rounded-full bg-emerald-500/15 border border-emerald-500/40 text-emerald-300"><i data-lucide="activity" class="w-3 h-3"></i>${detectedEvent}</span>`,
          );
        if (detectedColor)
          chips.push(
            `<span class="flex items-center gap-1 text-xs px-2.5 py-1 rounded-full bg-yellow-500/15 border border-yellow-500/40 text-yellow-300"><i data-lucide="palette" class="w-3 h-3"></i>${detectedColor}</span>`,
          );
        if (detectedAfter !== null)
          chips.push(
            `<span class="flex items-center gap-1 text-xs px-2.5 py-1 rounded-full bg-purple-500/15 border border-purple-500/40 text-purple-300"><i data-lucide="clock" class="w-3 h-3"></i>after ${fmt(detectedAfter)}</span>`,
          );

        const chipEl = document.getElementById("filter-chips");
        chipEl.innerHTML = chips.length
          ? '<span class="text-xs text-gray-600 self-center">Detected:</span>' +
            chips.join("")
          : "";

        if (!activeClass && detectedClass) setClassFilter(detectedClass);
        if (!activeEvent && detectedEvent) setEventFilter(detectedEvent);
        if (detectedAfter !== null)
          document.getElementById("search-min-sec").value = detectedAfter;
        if (detectedBefore !== null)
          document.getElementById("search-max-sec").value = detectedBefore;
        if (chips.length) lucide.createIcons();
      }

      function setClassFilter(cls) {
        activeClass = cls;
        document.querySelectorAll(".class-pill").forEach((btn) => {
          const active = btn.dataset.cls === cls;
          btn.className =
            "class-pill text-xs px-2.5 py-1 rounded-full border transition " +
            (active
              ? "border-indigo-500 text-indigo-300 bg-indigo-500/10"
              : "border-gray-700 text-gray-500 hover:border-gray-500");
        });
      }

      function setEventFilter(ev) {
        activeEvent = ev;
        document.querySelectorAll(".event-pill").forEach((btn) => {
          const active = btn.dataset.ev === ev;
          btn.className =
            "event-pill text-xs px-2.5 py-1 rounded-full border transition " +
            (active
              ? "border-indigo-500 text-indigo-300 bg-indigo-500/10"
              : "border-gray-700 text-gray-500 hover:border-gray-500");
        });
      }

      function toggleClassFilter(btn) {
        setClassFilter(activeClass === btn.dataset.cls ? "" : btn.dataset.cls);
      }

      function toggleEventFilter(btn) {
        setEventFilter(activeEvent === btn.dataset.ev ? "" : btn.dataset.ev);
      }

      async function doSearch() {
        const q = document.getElementById("search-input").value.trim();
        if (!q) return;
        const video = document.getElementById("search-video-filter").value;
        const minSec = document.getElementById("search-min-sec").value;
        const maxSec = document.getElementById("search-max-sec").value;
        const el = document.getElementById("search-results");
        document.getElementById("search-suggestions").style.display = "none";
        el.innerHTML = spinner();

        try {
          const base = new URLSearchParams({ q, top_k: 10 });
          if (video) base.set("video_filename", video);
          if (minSec) base.set("min_second", minSec);
          if (maxSec) base.set("max_second", maxSec);

          const evP = new URLSearchParams(base);
          if (activeClass) evP.set("object_class", activeClass);
          if (activeEvent) evP.set("event_type", activeEvent);

          const objP = new URLSearchParams(base);
          if (activeClass) objP.set("object_class", activeClass);

          const [evData, objData, capData] = await Promise.all([
            apiFetch(`/search/events?${evP}`).catch(() => ({ results: [] })),
            apiFetch(`/search/objects?${objP}`).catch(() => ({ results: [] })),
            apiFetch(`/search?${base}`).catch(() => ({ results: [] })),
          ]);

          const evResults = evData.results || [];
          const objResults = objData.results || [];
          const capResults = capData.results || [];

          if (!evResults.length && !objResults.length && !capResults.length) {
            el.innerHTML = `<div class="text-sm text-gray-500 text-center py-12">
                    <i data-lucide="search-x" class="w-8 h-8 mx-auto mb-3 opacity-30"></i>
                    <p>No results found for <span class="text-gray-400">"${q}"</span></p>
                  </div>`;
            lucide.createIcons();
            return;
          }

          // Separate exact (>=51%) from similar (<51%)
          const THRESHOLD = 0.51;
          const exactEv = evResults.filter((r) => r.score >= THRESHOLD);
          const similarEv = evResults.filter((r) => r.score < THRESHOLD);
          const exactObj = objResults.filter((r) => r.score >= THRESHOLD);
          const similarObj = objResults.filter((r) => r.score < THRESHOLD);
          const exactCap = capResults.filter((r) => r.score >= THRESHOLD);
          const similarCap = capResults.filter((r) => r.score < THRESHOLD);

          const hasExact = exactEv.length || exactObj.length || exactCap.length;
          const hasSimilar =
            similarEv.length || similarObj.length || similarCap.length;

          let html = "";

          if (hasExact) {
            html += buildResultSections(exactEv, exactObj, exactCap, false);
          }

          if (!hasExact && hasSimilar) {
            html += `<div class="mb-4 flex items-center gap-3">
                    <div class="flex-1 h-px bg-gray-800"></div>
                    <div class="flex items-center gap-2 text-xs text-yellow-500 px-3 py-1.5 rounded-full bg-yellow-500/10 border border-yellow-500/20">
                      <i data-lucide="alert-circle" class="w-3.5 h-3.5"></i>
                      No exact match found for <strong>"${q}"</strong>
                    </div>
                    <div class="flex-1 h-px bg-gray-800"></div>
                  </div>`;
            html += `<p class="text-xs text-gray-600 mb-3">Similar results:</p>`;
            html += buildResultSections(
              similarEv,
              similarObj,
              similarCap,
              true,
            );
          } else if (hasExact && hasSimilar) {
            html += `<div class="mt-5 mb-3 flex items-center gap-2">
                    <div class="h-px flex-1 bg-gray-800"></div>
                    <span class="text-xs text-gray-600 px-2">Similar results</span>
                    <div class="h-px flex-1 bg-gray-800"></div>
                  </div>`;
            html += buildResultSections(
              similarEv,
              similarObj,
              similarCap,
              true,
            );
          }

          el.innerHTML = html;
          lucide.createIcons();
        } catch (e) {
          el.innerHTML = errorBox(e.message);
        }
      }

      function buildResultSections(evResults, objResults, capResults, dimmed) {
        let html = "";
        const opacity = dimmed ? "opacity-70" : "";

        if (evResults.length) {
          html += `<div class="mb-4 ${opacity}">
                  <div class="flex items-center gap-2 mb-2">
                    <div class="h-px flex-1 bg-gray-800"></div>
                    <span class="text-xs text-gray-500 px-2 flex items-center gap-1.5">
                      <i data-lucide="activity" class="w-3 h-3 text-emerald-500"></i>
                      ${evResults.length} track event${evResults.length > 1 ? "s" : ""}
                    </span>
                    <div class="h-px flex-1 bg-gray-800"></div>
                  </div>
                  <div class="space-y-2">${evResults.map(trackEventCard).join("")}</div>
                </div>`;
        }

        if (objResults.length) {
          html += `<div class="mb-4 ${opacity}">
                  <div class="flex items-center gap-2 mb-2">
                    <div class="h-px flex-1 bg-gray-800"></div>
                    <span class="text-xs text-gray-500 px-2 flex items-center gap-1.5">
                      <i data-lucide="eye" class="w-3 h-3 text-yellow-500"></i>
                      ${objResults.length} frame detection${objResults.length > 1 ? "s" : ""}
                    </span>
                    <div class="h-px flex-1 bg-gray-800"></div>
                  </div>
                  <div class="grid grid-cols-2 gap-2">${objResults.map(frameDetectionCard).join("")}</div>
                </div>`;
        }

        if (capResults.length) {
          html += `<div class="mb-4 ${opacity}">
                  <div class="flex items-center gap-2 mb-2">
                    <div class="h-px flex-1 bg-gray-800"></div>
                    <span class="text-xs text-gray-500 px-2 flex items-center gap-1.5">
                      <i data-lucide="film" class="w-3 h-3 text-indigo-400"></i>
                      ${capResults.length} scene description${capResults.length > 1 ? "s" : ""}
                    </span>
                    <div class="h-px flex-1 bg-gray-800"></div>
                  </div>
                  <div class="space-y-2">${capResults.map(captionCard).join("")}</div>
                </div>`;
        }

        return html;
      }

      // ── Result cards ───────────────────────────────────────────────────────────

      function trackEventCard(r) {
        const score = Math.round((r.score || 0) * 100);
        const scoreColor =
          score >= 80
            ? "text-green-400"
            : score >= 51
              ? "text-yellow-400"
              : "text-gray-500";
        const matchBadge =
          r.match_type === "attribute_keyword"
            ? '<span class="text-xs px-1.5 py-0.5 rounded bg-yellow-500/10 text-yellow-400 border border-yellow-500/20">attr</span>'
            : "";
        const evColors = {
          entry: "bg-green-500/10 text-green-300 border-green-500/30",
          exit: "bg-red-500/10 text-red-300 border-red-500/30",
          dwell: "bg-yellow-500/10 text-yellow-300 border-yellow-500/30",
        };
        const evStyle =
          evColors[r.event_type] ||
          "bg-gray-500/10 text-gray-300 border-gray-500/30";

        // Build attribute pills
        let attrHtml = "";
        if (r.attributes) {
          const a = r.attributes;
          const cls = a.object_class || r.object_class || "";
          const pills = [];
          if (cls === "person") {
            if (a.gender_estimate && a.gender_estimate !== "unknown")
              pills.push(a.gender_estimate);
            if (a.clothing_top && a.clothing_top !== "unknown")
              pills.push(a.clothing_top);
            if (a.clothing_bottom && a.clothing_bottom !== "unknown")
              pills.push(a.clothing_bottom);
            if (
              a.head_covering &&
              !["unknown", "none"].includes(a.head_covering)
            )
              pills.push(a.head_covering);
            if (a.carrying && !["unknown", "none"].includes(a.carrying))
              pills.push("carrying: " + a.carrying);
          } else {
            if (a.color && a.color !== "unknown") pills.push(a.color);
            if (a.type && a.type !== "unknown") pills.push(a.type);
            if (a.make_estimate && a.make_estimate !== "unknown")
              pills.push(a.make_estimate);
            if (a.plate_visible) pills.push("plate visible");
          }
          if (pills.length) {
            attrHtml =
              '<div class="flex gap-1 flex-wrap mt-1.5">' +
              pills
                .map(
                  (p) =>
                    `<span class="text-xs px-2 py-0.5 rounded-full bg-yellow-500/10 border border-yellow-500/20 text-yellow-300">${p}</span>`,
                )
                .join("") +
              "</div>";
          }
        }

        // Build proof section (rag_text shown on expand)
        const ragText = r.rag_text
          ? r.rag_text.replace(/</g, "&lt;").replace(/>/g, "&gt;")
          : "";
        const proofHtml = ragText
          ? `
                <div class="proof-section hidden mt-2 p-2 rounded-lg bg-gray-900 border border-gray-800">
                  <p class="text-xs text-gray-500 mb-1 font-medium">Search index text (proof):</p>
                  <p class="text-xs text-gray-400 leading-relaxed">${ragText}</p>
                </div>`
          : "";

        return `<div class="glass rounded-xl p-3.5 fade-in cursor-pointer hover:border-gray-600 border border-transparent transition" onclick="toggleProof(this)">
                <div class="flex items-start gap-3">
                  ${
                    r.best_crop_path
                      ? `<img src="/api/v1/crop?path=${encodeURIComponent(r.best_crop_path)}"
                    class="w-20 h-16 object-cover rounded-lg shrink-0 bg-gray-800" onerror="this.style.display='none'" />`
                      : `<div class="w-20 h-16 bg-gray-800 rounded-lg shrink-0 flex items-center justify-center"><i data-lucide="box" class="w-5 h-5 text-gray-700"></i></div>`
                  }
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap mb-1">
                      <span class="text-xs font-semibold text-white capitalize">${r.object_class} #${r.track_id}</span>
                      <span class="text-xs px-2 py-0.5 rounded-full border ${evStyle} font-medium">${r.event_type}</span>
                      ${matchBadge}
                      <span class="text-xs text-gray-500 truncate">${r.video_filename}</span>
                      <span class="text-xs font-semibold ${scoreColor} ml-auto">${score}% match</span>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-gray-500">
                      <span>${fmt(r.first_seen)} → ${fmt(r.last_seen)}</span>
                      ${r.duration ? `<span>${r.duration.toFixed(1)}s</span>` : ""}
                      ${r.best_confidence ? `<span>${(r.best_confidence * 100).toFixed(0)}% conf</span>` : ""}
                      <span class="text-gray-700 text-xs ml-auto">click to expand</span>
                    </div>
                    ${attrHtml}
                    ${proofHtml}
                  </div>
                </div>
              </div>`;
      }

      function frameDetectionCard(r) {
        const score = Math.round((r.score || 0) * 100);
        const scoreColor =
          score >= 80
            ? "text-green-400"
            : score >= 51
              ? "text-yellow-400"
              : "text-gray-500";
        const ragText = (r.description || r.event_text || r.rag_text || "")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        const proofHtml = ragText
          ? `
                <div class="proof-section hidden mt-2 p-2 rounded-lg bg-gray-900 border border-gray-800">
                  <p class="text-xs text-gray-500 mb-1">Search index text:</p>
                  <p class="text-xs text-gray-400">${ragText}</p>
                </div>`
          : "";

        return `<div class="glass rounded-xl p-3 fade-in cursor-pointer hover:border-gray-600 border border-transparent transition" onclick="toggleProof(this)">
                <div class="flex items-center gap-3">
                  ${
                    r.crop_path
                      ? `<img src="/api/v1/crop?path=${encodeURIComponent(r.crop_path)}"
                    class="w-14 h-12 object-cover rounded-lg shrink-0 bg-gray-800" onerror="this.style.display='none'" />`
                      : ""
                  }
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-1.5 mb-0.5">
                      <span class="text-xs font-medium text-yellow-300 capitalize">${r.object_class}</span>
                      ${r.track_id ? `<span class="text-xs text-gray-600">#${r.track_id}</span>` : ""}
                      <span class="text-xs font-semibold ${scoreColor} ml-auto">${score}%</span>
                    </div>
                    <div class="text-xs text-gray-500">${fmt(r.second || r.frame_second_offset)} · ${r.quadrant || ""}</div>
                    <div class="text-xs text-gray-600 truncate">${r.video_filename}</div>
                    ${proofHtml}
                  </div>
                </div>
              </div>`;
      }

      function captionCard(r) {
        const score = Math.round(r.score * 100);
        const scoreColor =
          score >= 80
            ? "text-green-400"
            : score >= 51
              ? "text-yellow-400"
              : "text-gray-500";
        return `<div class="glass rounded-xl p-3.5 fade-in cursor-pointer hover:border-gray-600 border border-transparent transition" onclick="toggleProof(this)">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1.5">
                      <i data-lucide="film" class="w-3 h-3 text-indigo-400 shrink-0"></i>
                      <span class="text-xs text-indigo-300 font-medium truncate">${r.video_filename}</span>
                      <span class="text-xs text-gray-600">@</span>
                      <span class="text-xs text-gray-400">${fmt(r.second)}</span>
                      <span class="text-xs font-semibold ${scoreColor} ml-auto">${score}%</span>
                    </div>
                    <p class="text-xs text-gray-400 line-clamp-2 caption-preview">${r.caption}</p>
                    <p class="text-xs text-gray-300 hidden caption-full">${r.caption}</p>
                  </div>
                  ${
                    r.keyframe_path
                      ? `<img src="/api/v1/keyframe?path=${encodeURIComponent(r.keyframe_path)}"
                    class="w-20 h-14 object-cover rounded-lg shrink-0 bg-gray-800" onerror="this.style.display='none'" />`
                      : ""
                  }
                </div>
              </div>`;
      }

      // Legacy aliases
      function objectResultCard(r) {
        return frameDetectionCard(r);
      }
      function resultCard(r) {
        return captionCard(r);
      }

      function toggleProof(card) {
        // Toggle proof section visibility
        const proof = card.querySelector(".proof-section");
        if (proof) proof.classList.toggle("hidden");
        // Also toggle caption expand if present
        card.querySelector(".caption-preview")?.classList.toggle("hidden");
        card.querySelector(".caption-full")?.classList.toggle("hidden");
      }

      function expandCaption(card) {
        toggleProof(card);
      }

      // ── Ask ────────────────────────────────────────────────────────────────────────

      async function doAsk() {
        const q = document.getElementById("ask-input").value.trim();
        if (!q) return;
        const video = document.getElementById("ask-video-filter").value;
        const el = document.getElementById("ask-results");
        el.innerHTML = spinner();

        try {
          const body = { question: q };
          if (video) body.video_filename = video;
          const data = await apiFetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          el.innerHTML = `
            <div class="glass rounded-xl p-5 mb-4 fade-in">
              <div class="flex items-center gap-2 mb-3">
                <i data-lucide="sparkles" class="w-4 h-4 text-indigo-400"></i>
                <span class="text-sm font-medium">Answer</span>
              </div>
              <p class="text-sm text-gray-200 leading-relaxed">${data.answer}</p>
            </div>
            ${
              data.sources.length
                ? `
              <div class="mb-2 text-xs text-gray-500">Based on ${data.sources.length} source moments:</div>
              <div class="grid gap-3">
                ${data.sources.map((r) => resultCard(r)).join("")}
              </div>
            `
                : ""
            }
          `;
          lucide.createIcons();
        } catch (e) {
          el.innerHTML = errorBox(e.message);
        }
      }

      // ── Timeline ───────────────────────────────────────────────────────────────────

      async function doTimeline() {
        const video = document.getElementById("timeline-video-select").value;
        if (!video) return;
        const el = document.getElementById("timeline-results");
        el.innerHTML = spinner();

        try {
          const data = await apiFetch(`/timeline/${encodeURIComponent(video)}`);
          el.innerHTML = `
            <p class="text-xs text-gray-500 mb-4">${data.count} events in <span class="text-white">${video}</span></p>
            <div class="relative">
              <div class="absolute left-6 top-0 bottom-0 w-px bg-gray-800"></div>
              <div class="space-y-4">
                ${data.timeline
                  .map((item, i) => {
                    // Handle both old caption format and new tracking event format
                    const timestamp = item.second ?? item.first_seen ?? 0;
                    const displayText =
                      item.caption ??
                      `${item.event_type}: ${item.object_class} (Track ${item.track_id})`;
                    return `
                  <div class="flex gap-4 fade-in" style="animation-delay:${i * 30}ms">
                    <div class="relative z-10 w-12 h-12 shrink-0 flex items-center justify-center">
                      <div class="w-3 h-3 rounded-full bg-indigo-600 border-2 border-gray-950"></div>
                    </div>
                    <div class="flex-1 glass rounded-xl p-4 mb-0 cursor-pointer result-card" onclick="expandCaption(this)">
                      <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-mono text-indigo-300">${fmt(timestamp)}</span>
                        <span class="text-xs text-gray-600">${timestamp.toFixed(1)}s</span>
                      </div>
                      <p class="text-xs text-gray-400 line-clamp-2 caption-preview">${displayText}</p>
                      <p class="text-xs text-gray-300 hidden caption-full">${displayText}</p>
                      ${
                        item.keyframe_path || item.best_crop_path
                          ? `
                        <img src="/api/v1/${item.keyframe_path ? "keyframe" : "crop"}?path=${encodeURIComponent(item.keyframe_path || item.best_crop_path)}"
                          class="mt-3 w-full max-w-xs h-32 object-cover rounded-lg bg-gray-800"
                          onerror="this.style.display='none'" />
                      `
                          : ""
                      }
                    </div>
                  </div>
                `;
                  })
                  .join("")}
              </div>
            </div>
          `;
        } catch (e) {
          el.innerHTML = errorBox(e.message);
        }
      }

      // ── Summary ────────────────────────────────────────────────────────────────────

      async function doSummary(force = false) {
        const video = document.getElementById("summary-video-select").value;
        if (!video) return;
        const el = document.getElementById("summary-results");
        el.innerHTML = spinner();

        try {
          let data;
          if (force) {
            data = await apiFetch(
              `/summarize/${encodeURIComponent(video)}?force=true`,
              { method: "POST" },
            );
          } else {
            try {
              data = await apiFetch(`/summary/${encodeURIComponent(video)}`);
              // normalize field name
              if (data.summary_text) data.summary = data.summary_text;
            } catch (e) {
              if (e.message.includes("No summary")) {
                data = await apiFetch(
                  `/summarize/${encodeURIComponent(video)}`,
                  { method: "POST" },
                );
              } else throw e;
            }
          }

          el.innerHTML = `
            <div class="glass rounded-xl p-5 fade-in">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <i data-lucide="file-text" class="w-4 h-4 text-indigo-400"></i>
                  <span class="text-sm font-medium">${video}</span>
                </div>
                <div class="flex gap-3 text-xs text-gray-500">
                  <span>${data.caption_count} scenes</span>
                  <span>${fmt(data.duration_seconds)} duration</span>
                  <span class="text-gray-600">${data.model_name}</span>
                </div>
              </div>
              <pre class="text-xs text-gray-300 leading-relaxed">${data.summary || data.summary_text}</pre>
            </div>
          `;
          lucide.createIcons();
        } catch (e) {
          el.innerHTML = errorBox(e.message);
        }
      }

      // ── Attribute rendering helper ──────────────────────────────────────────────

      function renderAttributes(attrs) {
        if (!attrs) return "";
        const cls = attrs.object_class || "";
        const parts = [];

        if (cls === "person") {
          if (attrs.gender_estimate && attrs.gender_estimate !== "unknown")
            parts.push(attrs.gender_estimate);
          if (attrs.clothing_top && attrs.clothing_top !== "unknown")
            parts.push(attrs.clothing_top);
          if (attrs.clothing_bottom && attrs.clothing_bottom !== "unknown")
            parts.push(attrs.clothing_bottom);
          if (
            attrs.head_covering &&
            attrs.head_covering !== "unknown" &&
            attrs.head_covering !== "none"
          )
            parts.push(attrs.head_covering);
          if (
            attrs.carrying &&
            attrs.carrying !== "unknown" &&
            attrs.carrying !== "none"
          )
            parts.push(`carrying: ${attrs.carrying}`);
        } else {
          if (attrs.color && attrs.color !== "unknown") parts.push(attrs.color);
          if (attrs.type && attrs.type !== "unknown") parts.push(attrs.type);
          if (attrs.make_estimate && attrs.make_estimate !== "unknown")
            parts.push(attrs.make_estimate);
          if (attrs.plate_visible) parts.push("plate visible");
        }

        if (!parts.length) return "";
        return `<div class="text-xs text-yellow-400 mt-1 truncate" title="${parts.join(", ")}">${parts.join(" · ")}</div>`;
      }

      // ── Detections ─────────────────────────────────────────────────────────────────

      async function doDetections() {
        const video = document.getElementById("detections-video-select").value;
        if (!video) return;
        const mode = document.getElementById("detections-mode").value;
        const cls = document.getElementById("detections-class-filter").value;
        const el = document.getElementById("detections-results");
        el.innerHTML = spinner();

        try {
          let data;
          if (mode === "tracks") {
            const params = new URLSearchParams();
            if (cls) params.set("object_class", cls);
            data = await apiFetch(
              `/tracks/${encodeURIComponent(video)}?${params}`,
            );
            if (!data.track_events.length) {
              el.innerHTML = `<div class="text-sm text-gray-500 text-center py-8">No tracks found. Run the detection pipeline first.</div>`;
              return;
            }
            el.innerHTML = `
                    <p class="text-xs text-gray-500 mb-4">${data.count} tracks in <span class="text-white">${video}</span></p>
                    <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-4">
                      ${data.track_events
                        .map(
                          (t) => `
                        <div class="glass rounded-xl p-3 fade-in">
                          ${
                            t.best_crop_path
                              ? `
                            <img src="/api/v1/crop?path=${encodeURIComponent(t.best_crop_path)}"
                              class="w-full h-28 object-cover rounded-lg bg-gray-800 mb-2"
                              onerror="this.style.display='none'" />
                          `
                              : `<div class="w-full h-28 bg-gray-800 rounded-lg mb-2 flex items-center justify-center text-gray-600 text-xs">no crop</div>`
                          }
                          <div class="text-xs font-medium text-indigo-300">${t.object_class}</div>
                          <div class="text-xs text-gray-500">Track #${t.track_id} · ${t.event_type}</div>
                          <div class="text-xs text-gray-600">${fmt(t.first_seen)} → ${fmt(t.last_seen)}</div>
                          <div class="text-xs text-gray-600">conf: ${(t.best_confidence * 100).toFixed(0)}%</div>
                          ${t.attributes ? renderAttributes(t.attributes) : ""}
                        </div>
                      `,
                        )
                        .join("")}
                    </div>
                  `;
          } else if (mode === "detections") {
            const params = new URLSearchParams();
            if (cls) params.set("object_class", cls);
            data = await apiFetch(
              `/detections/${encodeURIComponent(video)}?${params}`,
            );
            if (!data.detections.length) {
              el.innerHTML = `<div class="text-sm text-gray-500 text-center py-8">No detections found.</div>`;
              return;
            }
            el.innerHTML = `
                    <p class="text-xs text-gray-500 mb-4">${data.count} detections in <span class="text-white">${video}</span></p>
                    <div class="grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-4">
                      ${data.detections
                        .map(
                          (d) => `
                        <div class="glass rounded-xl p-3 fade-in">
                          ${
                            d.crop_path
                              ? `
                            <img src="/api/v1/crop?path=${encodeURIComponent(d.crop_path)}"
                              class="w-full h-24 object-cover rounded-lg bg-gray-800 mb-2"
                              onerror="this.style.display='none'" />
                          `
                              : `<div class="w-full h-24 bg-gray-800 rounded-lg mb-2 flex items-center justify-center text-gray-600 text-xs">no crop</div>`
                          }
                          <div class="text-xs font-medium text-indigo-300">${d.object_class}</div>
                          <div class="text-xs text-gray-500">@ ${fmt(d.second)} · ${d.quadrant}</div>
                          <div class="text-xs text-gray-600">conf: ${(d.confidence * 100).toFixed(0)}% · track #${d.track_id ?? "?"}</div>
                        </div>
                      `,
                        )
                        .join("")}
                    </div>
                  `;
          } else {
            // events
            const params = new URLSearchParams();
            if (cls) params.set("object_class", cls);
            data = await apiFetch(
              `/tracks/${encodeURIComponent(video)}?${params}`,
            );
            el.innerHTML = `
                    <p class="text-xs text-gray-500 mb-4">${data.count} track events in <span class="text-white">${video}</span></p>
                    <div class="space-y-2">
                      ${data.track_events
                        .map(
                          (e) => `
                        <div class="glass rounded-xl p-3 flex items-center gap-4 fade-in">
                          ${
                            e.best_crop_path
                              ? `
                            <img src="/api/v1/crop?path=${encodeURIComponent(e.best_crop_path)}"
                              class="w-16 h-12 object-cover rounded-lg bg-gray-800 shrink-0"
                              onerror="this.style.display='none'" />
                          `
                              : ""
                          }
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                              <span class="text-xs font-medium text-indigo-300">${e.object_class}</span>
                              <span class="text-xs px-1.5 py-0.5 rounded ${
                                e.event_type === "entry"
                                  ? "bg-green-900 text-green-400"
                                  : e.event_type === "exit"
                                    ? "bg-red-900 text-red-400"
                                    : "bg-yellow-900 text-yellow-400"
                              }">${e.event_type}</span>
                              <span class="text-xs text-gray-600">Track #${e.track_id}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-0.5">${fmt(e.first_seen)} → ${fmt(e.last_seen)} · ${e.duration?.toFixed(1) ?? "?"}s</div>
                          </div>
                          <div class="text-xs text-gray-600">${(e.best_confidence * 100).toFixed(0)}%</div>
                          ${e.attributes ? renderAttributes(e.attributes) : ""}
                        </div>
                      `,
                        )
                        .join("")}
                    </div>
                  `;
          }
          lucide.createIcons();
        } catch (e) {
          el.innerHTML = errorBox(e.message);
        }
      }

      // ── Ingest actions ─────────────────────────────────────────────────────────────

      async function doExtractAttributes() {
        const video = document.getElementById("attr-video-select").value;
        if (!video) return;
        const el = document.getElementById("attr-result");
        el.textContent =
          "Running minicpm-v on crops... this may take a while (~30s per tracked object).";
        el.className = "mt-3 text-sm text-yellow-400";
        try {
          const data = await apiFetch(
            `/extract-attributes/${encodeURIComponent(video)}`,
            { method: "POST" },
          );
          el.textContent = `✓ ${data.message}`;
          el.className = "mt-3 text-sm text-green-400";
        } catch (e) {
          el.textContent = `Error: ${e.message}`;
          el.className = "mt-3 text-sm text-red-400";
        }
      }

      async function doReindex() {
        const el = document.getElementById("reindex-result");
        el.textContent = "Running...";
        try {
          const data = await apiFetch("/index", { method: "POST" });
          el.textContent = `✓ Indexed ${data.indexed} new caption(s).`;
          el.className = "mt-3 text-sm text-green-400";
        } catch (e) {
          el.textContent = `Error: ${e.message}`;
          el.className = "mt-3 text-sm text-red-400";
        }
      }

      async function doSummarizeAll(force = false) {
        const el = document.getElementById("summarize-all-result");
        el.textContent = "Running... this may take a few minutes.";
        try {
          const data = await apiFetch(`/summarize-all?force=${force}`, {
            method: "POST",
          });
          el.textContent = `✓ Summarized ${data.summarized} video(s): ${data.videos.join(", ")}`;
          el.className = "mt-3 text-sm text-green-400";
          await init(); // refresh sidebar
        } catch (e) {
          el.textContent = `Error: ${e.message}`;
          el.className = "mt-3 text-sm text-red-400";
        }
      }

      const TERMINAL_STATES = new Set(["completed", "skipped", "failed"]);
      let _pollTimer = null;

      async function pollPipelineStatus() {
        try {
          const data = await apiFetch("/status");
          const el = document.getElementById("pipeline-status");
          if (!el) return;

          if (!data.statuses.length) {
            el.innerHTML = '<div class="text-gray-600">No jobs yet</div>';
            // Keep polling — pipeline may not have registered jobs yet
            // Do NOT return here before the allDone check (old bug)
          } else {
            const colors = {
              completed: "text-green-400",
              running: "text-yellow-400",
              failed: "text-red-400",
              pending: "text-gray-500",
              skipped: "text-gray-600",
            };

            el.innerHTML = data.statuses
              .map((s) => {
                const color = colors[s.status] || "text-gray-400";
                const pct =
                  s.progress_pct != null ? " " + s.progress_pct + "%" : "";
                const errMsg = s.last_error
                  ? s.last_error.slice(0, 50) + "..."
                  : "";
                const err = s.last_error
                  ? '<div class="text-red-500 truncate" title="' +
                    s.last_error +
                    '">⚠ ' +
                    errMsg +
                    "</div>"
                  : "";
                const bar =
                  s.status === "running" && s.progress_pct != null
                    ? '<div class="w-full bg-gray-800 rounded-full h-1 mt-1"><div class="bg-yellow-400 h-1 rounded-full" style="width:' +
                      s.progress_pct +
                      '%"></div></div>'
                    : "";
                return (
                  '<div class="glass rounded-lg p-2">' +
                  '<div class="flex justify-between items-center">' +
                  '<span class="truncate font-medium" style="max-width:120px" title="' +
                  s.video_filename +
                  '">' +
                  s.video_filename +
                  "</span>" +
                  '<span class="' +
                  color +
                  ' font-mono">' +
                  s.status +
                  pct +
                  "</span>" +
                  "</div>" +
                  '<div class="text-gray-600 mt-0.5">' +
                  s.scenes_captioned +
                  "/" +
                  s.scenes_detected +
                  " scenes" +
                  (s.current_second != null
                    ? " @ " + s.current_second.toFixed(1) + "s"
                    : "") +
                  "</div>" +
                  bar +
                  err +
                  "</div>"
                );
              })
              .join("");
          }

          // FIXED: only stop when jobs exist AND every one is terminal.
          // hasJobs guard prevents [].every() = true from killing the timer
          // before the pipeline has even started registering work.
          const hasJobs = data.statuses.length > 0;
          const allDone =
            hasJobs &&
            data.statuses.every((s) => TERMINAL_STATES.has(s.status));
          if (allDone && _pollTimer !== null) {
            clearInterval(_pollTimer);
            _pollTimer = null;
          }
        } catch (e) {
          /* non-critical — network blip, keep polling */
        }
      }

      function startStatusPolling() {
        pollPipelineStatus();
        _pollTimer = setInterval(pollPipelineStatus, 5000);
      }

      // ── Boot ───────────────────────────────────────────────────────────────────────
      lucide.createIcons();
      init();
      startStatusPolling();
    </script>
  </body>
</html>
